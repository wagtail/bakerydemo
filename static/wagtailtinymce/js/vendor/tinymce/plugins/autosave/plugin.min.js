/**
 * Copyright (c) Tiny Technologies, Inc. All rights reserved.
 * Licensed under the LGPL or a commercial license.
 * For LGPL see License.txt in the project root for license information.
 * For commercial licenses see https://www.tiny.cloud/
 *
 * Version: 6.0.0 (TBD)
 */
!function(){"use strict";var e=tinymce.util.Tools.resolve("tinymce.PluginManager");const t=("string",e=>"string"===(e=>{const t=typeof e;return null===e?"null":"object"===t&&Array.isArray(e)?"array":"object"===t&&(r=o=e,(a=String).prototype.isPrototypeOf(r)||(null===(s=o.constructor)||void 0===s?void 0:s.name)===a.name)?"string":t;var r,o,a,s})(e));const r=(void 0,e=>undefined===e);var o=tinymce.util.Tools.resolve("tinymce.util.Delay"),a=tinymce.util.Tools.resolve("tinymce.util.LocalStorage"),s=tinymce.util.Tools.resolve("tinymce.util.Tools");const n=e=>{const t=/^(\d+)([ms]?)$/.exec(e);return(t[2]?{s:1e3,m:6e4}[t[2]]:1)*parseInt(e,10)},i=e=>t=>t.options.get(e),u=i("autosave_ask_before_unload"),l=i("autosave_restore_when_empty"),c=i("autosave_interval"),m=i("autosave_retention"),f=e=>{const t=document.location;return e.options.get("autosave_prefix").replace(/{path}/g,t.pathname).replace(/{query}/g,t.search).replace(/{hash}/g,t.hash).replace(/{id}/g,e.id)},d=(e,t)=>{if(r(t))return e.dom.isEmpty(e.getBody());{const r=s.trim(t);if(""===r)return!0;{const t=(new DOMParser).parseFromString(r,"text/html");return e.dom.isEmpty(t)}}},v=e=>{const t=parseInt(a.getItem(f(e)+"time"),10)||0;return!((new Date).getTime()-t>m(e)&&(g(e,!1),1))},g=(e,t)=>{const r=f(e);a.removeItem(r+"draft"),a.removeItem(r+"time"),!1!==t&&(e=>{e.fire("RemoveDraft")})(e)},p=e=>{const t=f(e);!d(e)&&e.isDirty()&&(a.setItem(t+"draft",e.getContent({format:"raw",no_events:!0})),a.setItem(t+"time",(new Date).getTime().toString()),(e=>{e.fire("StoreDraft")})(e))},y=e=>{const t=f(e);v(e)&&(e.setContent(a.getItem(t+"draft"),{format:"raw"}),(e=>{e.fire("RestoreDraft")})(e))},D=e=>{e.undoManager.transact((()=>{y(e),g(e)})),e.focus()};var _=tinymce.util.Tools.resolve("tinymce.EditorManager");const h=e=>t=>{t.setDisabled(!v(e));const r=()=>t.setDisabled(!v(e));return e.on("StoreDraft RestoreDraft RemoveDraft",r),()=>e.off("StoreDraft RestoreDraft RemoveDraft",r)};e.add("autosave",(e=>((e=>{const r=e.options.register,o=e=>{const r=t(e);return r?{value:n(e),valid:r}:{valid:!1,message:"Must be a string."}};r("autosave_ask_before_unload",{processor:"boolean",default:!0}),r("autosave_prefix",{processor:"string",default:"tinymce-autosave-{path}{query}{hash}-{id}-"}),r("autosave_restore_when_empty",{processor:"boolean",default:!1}),r("autosave_interval",{processor:o,default:"30s"}),r("autosave_retention",{processor:o,default:"20m"})})(e),(e=>{e.editorManager.on("BeforeUnload",(e=>{let t;s.each(_.get(),(e=>{e.plugins.autosave&&e.plugins.autosave.storeDraft(),!t&&e.isDirty()&&u(e)&&(t=e.translate("You have unsaved changes are you sure you want to navigate away?"))})),t&&(e.preventDefault(),e.returnValue=t)}))})(e),(e=>{(e=>{const t=c(e);o.setEditorInterval(e,(()=>{p(e)}),t)})(e),e.ui.registry.addButton("restoredraft",{tooltip:"Restore last draft",icon:"restore-draft",onAction:()=>{D(e)},onSetup:h(e)}),e.ui.registry.addMenuItem("restoredraft",{text:"Restore last draft",icon:"restore-draft",onAction:()=>{D(e)},onSetup:h(e)})})(e),e.on("init",(()=>{l(e)&&e.dom.isEmpty(e.getBody())&&y(e)})),(e=>({hasDraft:()=>v(e),storeDraft:()=>p(e),restoreDraft:()=>y(e),removeDraft:t=>g(e,t),isEmpty:t=>d(e,t)}))(e))))}();